!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.jso=t():e.jso=t()}(self,(function(){return(()=>{"use strict";var e={306:e=>{e.exports=JSON.parse('{"name":"jso","version":"4.1.2","description":"OAuth 2.0 implementation in Javascript","main":"dist/jso.js","module":"src/JSO.js","scripts":{"test":"true","preversion":"npm test","version":"npm run build && git add -A dist","postversion":"git push && git push --tags && npm publish","build":"webpack --mode production --config webpack.config.js","start":"webpack --mode development --config webpack.start.config.js && npx http-server examples -o -p 3000 -c-1"},"repository":{"type":"git","url":"https://github.com/vrseraphin/jso.git"},"keywords":["oauth","authentication","authorization","rest","api","ajax","jquery"],"files":["src"],"eslintConfig":{"env":{"es6":true,"browser":true,"node":false}},"devDependencies":{"@babel/core":"^7.12.9","@babel/preset-env":"^7.12.7","@babel/preset-react":"^7.12.7","@babel/preset-typescript":"^7.12.7","@babel/runtime":"^7.12.5","@types/core-js":"^2.5.4","babel-loader":"^8.2.2","qunit":"^2.13.0","webpack":"^5.10.0","webpack-cli":"^4.2.0"},"author":"Andreas Ã…kre Solberg","license":"LGPL-2.1","bugs":{"url":"https://github.com/andreassolberg/jso/issues"},"homepage":"https://github.com/andreassolberg/jso","dependencies":{}}')}},t={};function n(o){var r=t[o];if(void 0!==r)return r.exports;var i=t[o]={exports:{}};return e[o](i,i.exports,n),i.exports}n.d=(e,t)=>{for(var o in t)n.o(t,o)&&!n.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var o={};return(()=>{n.r(o),n.d(o,{BasicLoader:()=>u,Fetcher:()=>H,FetcherJQuery:()=>D,HTTPRedirect:()=>y,IFrameActive:()=>R,IFramePassive:()=>w,JSO:()=>le,Popup:()=>q});var e={epoch:function(){return Math.round((new Date).getTime()/1e3)},debug:!1,uuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))},getResponseFromURL:function(t){return-1!==t.indexOf("#")?e.parseQueryString(t.substring(t.indexOf("#")+1)):-1!==t.indexOf("?")?e.parseQueryString(t.substring(t.indexOf("?")+1)):{}},parseQueryString:function(e){for(var t,n=/\+/g,o=/([^&;=]+)=?([^&;]*)/g,r=function(e){return decodeURIComponent(e.replace(n," "))},i=e,c={};t=o.exec(i);)c[r(t[1])]=r(t[2]);return c},scopeList:function(t){return e.uniqueList(t).join(" ")},uniqueList:function(e){for(var t={},n=[],o=0;o<e.length;o++)t[e[o]]=1;for(var r in t)t.hasOwnProperty(r)&&n.push(r);return n},log:function(t){if(console&&console.log&&e.debug){var n=Array.prototype.slice.call(arguments);n.unshift("[JSO]"),console.log.apply(console,n)}},encodeQS:function(e){var t,n="",o=0;for(t in e)n+=(0==o++?"":"&")+encodeURIComponent(t)+"="+encodeURIComponent(e[t]);return n},encodeURL:function(e,t){var n,o=e,r=0,i=-1===e.indexOf("?")?"?":"&";for(n in t)o+=(0==r++?i:"&")+encodeURIComponent(n)+"="+encodeURIComponent(t[n]);return o},sha256Hash:function(e){return window.crypto.subtle.digest("SHA-256",(new TextEncoder).encode(e))},encode64:function(e){return btoa(new Uint8Array(e).reduce((function(e,t){return e+String.fromCharCode(t)}),""))},base64UrlSafeEncode:function(t){return e.encode64(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")},getCodeChallenge:function(t){return e.sha256Hash(t).then((function(t){return e.base64UrlSafeEncode(t)})).catch((function(t){e.log(t)})).finally((function(){return null}))}};const t=e;function r(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}const i=new(function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var n,o;return n=e,(o=[{key:"saveState",value:function(e,t){sessionStorage.setItem("state-"+e,JSON.stringify(t))}},{key:"getState",value:function(e){var t=JSON.parse(sessionStorage.getItem("state-"+e));return sessionStorage.removeItem("state-"+e),t}},{key:"hasScope",value:function(e,t){var n;if(!e.scopes)return!1;for(n=0;n<e.scopes.length;n++)if(e.scopes[n]===t)return!0;return!1}},{key:"filterTokens",value:function(e,n){var o,r,i,c=[],u=t.epoch();for(n||(n=[]),o=0;o<e.length;o++){for(i=!0,e[o].expires&&e[o].expires<u+1&&(i=!1),r=0;r<n.length;r++)this.hasScope(e[o],n[r])||(i=!1);i&&c.push(e[o])}return c}},{key:"saveTokens",value:function(e,t){sessionStorage.setItem("tokens-"+e,JSON.stringify(t))}},{key:"getTokens",value:function(e){var n=JSON.parse(sessionStorage.getItem("tokens-"+e));return n||(n=[]),t.log("Token found when loooking up provider "+e+" in store "+window.location.href,n),n}},{key:"wipeTokens",value:function(e){sessionStorage.removeItem("tokens-"+e)}},{key:"saveToken",value:function(e,t){var n=this.getTokens(e);(n=this.filterTokens(n)).push(t),this.saveTokens(e,n)}},{key:"getToken",value:function(e,t){var n=this.getTokens(e);return(n=this.filterTokens(n,t)).length<1?null:n[0]}}])&&r(n.prototype,o),e}());function c(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var u=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),console.log("Initializing a loader with url "+t),this.url=t}var t,n;return t=e,(n=[{key:"execute",value:function(){}}])&&c(t.prototype,n),e}();function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function f(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function p(e,t){return!t||"object"!==a(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var y=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)}(c,e);var t,n,o,r,i=(o=c,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=h(o);if(r){var n=h(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return p(this,e)});function c(){return s(this,c),i.apply(this,arguments)}return t=c,(n=[{key:"execute",value:function(){var e=this;return new Promise((function(t,n){window.location=e.url}))}}])&&f(t.prototype,n),c}(u);function d(e){return(d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function b(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function v(e,t){return(v=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function g(e,t){return!t||"object"!==d(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function m(e){return(m=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var w=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&v(e,t)}(u,e);var n,o,r,i,c=(r=u,i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=m(r);if(i){var n=m(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return g(this,e)});function u(e){var n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,u),(n=c.call(this,e)).timeout=5e3,n.callback=null,n.isCompleted=!1,n.id="jso_passive_iframe_"+t.uuid();var o=window.addEventListener?"addEventListener":"attachEvent";return window[o],n.iframe=document.createElement("iframe"),n.iframe.setAttribute("id",n.id),n.iframe.setAttribute("src",e),n.iframe.addEventListener("load",(function(e){var o=null;try{if(n.iframe.contentWindow.location.hash){var r=n.iframe.contentWindow.location.hash.substring(1);o=t.parseQueryString(r)}else if(n.iframe.contentWindow.location.search){var i=n.iframe.contentWindow.location.search.substring(1);o=t.parseQueryString(i)}null!==o?n._completed(o):n._failed(new Error("Failed to obtain response value from iframe"))}catch(e){}})),n}return n=u,(o=[{key:"execute",value:function(){var e=this;return new Promise((function(t,n){e.callback=t,e.errorCallback=n,document.getElementsByTagName("body")[0].appendChild(e.iframe),setTimeout((function(){e._failed(new Error("Loading iframe timed out"))}),e.timeout)}))}},{key:"_cleanup",value:function(){var e=document.getElementById(this.id);e.parentNode.removeChild(e)}},{key:"_failed",value:function(e){this.isCompleted||(this.errorCallback&&"function"==typeof this.errorCallback&&this.errorCallback(e),this.isCompleted=!0,this._cleanup())}},{key:"_completed",value:function(e){this.isCompleted||(this.callback&&"function"==typeof this.callback&&this.callback(e),this.isCompleted=!0,this._cleanup())}}])&&b(n.prototype,o),u}(u);function k(e){return(k="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function O(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function j(e,t){return(j=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function S(e,t){return!t||"object"!==k(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function x(e){return(x=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var R=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&j(e,t)}(c,e);var t,n,o,r,i=(o=c,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=x(o);if(r){var n=x(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return S(this,e)});function c(){return _(this,c),i.apply(this,arguments)}return t=c,(n=[{key:"execute",value:function(){var e=this;return new Promise((function(t,n){var o=document.getElementById("jsoActiveIframe");o.addEventListener("load",(function(){o.contentWindow;try{o.contentWindow.postMessage("JSO",window.location.origin)}catch(e){}}),!0),window.addEventListener("message",(function(e){if(e.origin==location.origin){var n=e.data.toString();-1!=n.indexOf("?code=")&&t(n)}}),!1),o.setAttribute("src",e.url),window.focus&&o.contentWindow&&o.contentWindow.focus()}))}}])&&O(t.prototype,n),c}(u);function P(e){return(P="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function E(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function T(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function C(e,t){return(C=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function L(e,t){return!t||"object"!==P(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function A(e){return(A=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var q=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&C(e,t)}(c,e);var t,n,o,r,i=(o=c,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=A(o);if(r){var n=A(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return L(this,e)});function c(){return E(this,c),i.apply(this,arguments)}return t=c,(n=[{key:"execute",value:function(){var e=this;return new Promise((function(t,n){window.popupCompleted=function(){var e=i.location.href;t(e)};var o=screen.width/2-210,r=screen.height/2-325,i=window.open(e.url,"jso-popup-auth","toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=420, height=650, top="+r+", left="+o);if(null===i)throw new Error("Error loading popup window");window.focus&&i.focus()}))}}])&&T(t.prototype,n),c}(u);function I(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var B=function(){function e(t){for(var n in function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),t)this[n]=t[n]}var t,n;return t=e,(n=[{key:"set",value:function(e,t){return this[e]=t,this}}])&&I(t.prototype,n),e}();function z(e){return(z="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function V(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function U(e,t){return(U=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function J(e,t){return!t||"object"!==z(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function N(e){return(N=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var F=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&U(e,t)}(r,e);var t,n,o=(t=r,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,o=N(t);if(n){var r=N(this).constructor;e=Reflect.construct(o,arguments,r)}else e=o.apply(this,arguments);return J(this,e)});function r(){return V(this,r),o.apply(this,arguments)}return r}(B);function W(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var H=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.jso=t}var t,n;return t=e,(n=[{key:"_fetch",value:function(e,t){return fetch(e,t).then((function(e){if(401===e.status)throw new F;return e}))}},{key:"fetch",value:function(e,t,n){var o=this;if((n=n||0)>2)throw new Error("Reccursion error. Expired tokens deleted and tried again multiple times.");var r={},i={mode:"cors"};return t&&(i=t,Object.assign(i,t)),t&&t.jso&&Object.assign(r,t.jso),this.jso.getToken(r).catch((function(e){console.error("Error fetching token to use ",e)})).then((function(r){return i.headers||(i.headers={}),i.headers.Authorization="Bearer "+r.access_token,o._fetch(e,i).catch((function(r){if(r instanceof F)return console.error("Token was expired. Deleting all tokens for this provider and get a new one",r),o.jso.wipeTokens(),o.fetch(e,t,n+1)}))}))}}])&&W(t.prototype,n),e}();function Q(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var D=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.jso=t,this.jquery=n}var t,n;return t=e,(n=[{key:"_fetch",value:function(e,t){var n=this;return new Promise((function(o,r){return t.done=o,t.fail=function(e,t,o){return 401===parseInt(t,10)?(n.jso.wipeTokens(),r(new F)):r(o)},n.jquery.ajax(e,t)}))}},{key:"fetch",value:function(e,t,n){var o=this;if((n=n||0)>2)throw new Error("Reccursion error. Expired tokens deleted and tried again multiple times.");var r={},i={mode:"cors"};return t&&(i=t,Object.assign(i,t)),t&&t.jso&&Object.assign(r,t.jso),this.jso.getToken(r).catch((function(e){console.error("Error fetching token to use ",e)})).then((function(r){return i.headers||(i.headers={}),i.headers.Authorization="Bearer "+r.access_token,o._fetch(e,i).catch((function(r){if(r instanceof F)return console.error("Token was expired. Deleting all tokens for this provider and get a new one",r),o.jso.wipeTokens(),o.fetch(e,t,n+1)}))}))}}])&&Q(t.prototype,n),e}();function M(e){return(M="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function G(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function K(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function X(e,t){return(X=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Y(e,t){return!t||"object"!==M(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Z(e){return(Z=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var $=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&X(e,t)}(c,e);var t,n,o,r,i=(o=c,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=Z(o);if(r){var n=Z(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return Y(this,e)});function c(){return G(this,c),i.apply(this,arguments)}return t=c,(n=[{key:"toString",value:function(){return"OAuthResponseError: ["+(this.error||"unknown")+"]: "+(this.error_description||"unknown")}}])&&K(t.prototype,n),c}(B);function ee(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function te(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var ne=function(){function e(){ee(this,e),this.config={};for(var t=0;t<arguments.length;t++)Object.assign(this.config,arguments[t]);this.config.token&&(this.config.use_pkce=!0)}var t,n;return t=e,(n=[{key:"has",value:function(e){var t=this.config,n=e.split("."),o=0;for(o=0;o<n.length;o++){if(!t.hasOwnProperty(n[o]))return!1;t=t[n[o]]}return!0}},{key:"getValue",value:function(e,t,n){n=n||!1;var o=this.config,r=e.split("."),i=0;for(i=0;i<r.length;i++){if(!o.hasOwnProperty(r[i])){o=void 0;break}o=o[r[i]]}if(void 0===o){if(n)throw new Error("Configuration option ["+r[i]+"] required but not provided.");return t}return o}}])&&te(t.prototype,n),e}();function oe(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var re=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,(n=[{key:"on",value:function(e,t){this._callbacks||(this._callbacks={}),this._callbacks[e]||(this._callbacks[e]=[]),this._callbacks[e].push(t)}},{key:"emit",value:function(e){this._callbacks||(this._callbacks={}),this._callbacks[e]||(this._callbacks[e]=[]);for(var t=Array.prototype.slice.call(arguments,1),n=0;n<this._callbacks[e].length;n++)this._callbacks[e][n].apply(this,t)}}])&&oe(t.prototype,n),e}();function ie(e){return(ie="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ce(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function ue(e,t){return(ue=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function ae(e,t){return!t||"object"!==ie(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function se(e){return(se=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}n(306);var fe={lifetime:3600,response_type:"token"},le=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ue(e,t)}(s,e);var n,o,r,c,a=(r=s,c=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=se(r);if(c){var n=se(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return ae(this,e)});function s(e){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,s),(n=a.call(this)).configure(e),n.connector_name=n.getconnector_name(),n.Loader=q,n.store=i,n.callbacks={},n.config.getValue("debug",!1)&&(t.debug=!0),n}return n=s,(o=[{key:"configure",value:function(e){this.config=new ne(fe,e)}},{key:"setStore",value:function(e){this.store=e}},{key:"setLoader",value:function(e){if("function"!=typeof e)throw new Error("loader MUST be an instance of the JSO BasicLoader");this.Loader=e}},{key:"getconnector_name",value:function(){var e=this.config.getValue("connector_name",null);if(null!==e)return e;var t=this.config.getValue("client_id",null,!0);return this.config.getValue("authorization",null,!0)+"|"+t}},{key:"processTokenResponse",value:function(e){var n;if(!e.state)throw new Error("Could not get state from storage.");if(!(n=this.store.getState(e.state)))throw new Error("Could not retrieve state");if(!n.connector_name)throw new Error("Could not get connector_name from state");return t.log("processTokenResponse ",e,""),this.processReceivedToken(e,n)}},{key:"processReceivedToken",value:function(e,n){var o=t.epoch();e.received=o,e.expires_in?(e.expires=o+parseInt(e.expires_in,10),e.expires_in=parseInt(e.expires_in,10)):!1===this.config.getValue("default_lifetime",null)?e.expires=null:this.config.has("permanent_scope")?this.store.hasScope(e,this.config.getValue("permanent_scope"))||(e.expires=null):this.config.has("default_lifetime")?e.expires=o+this.config.getValue("default_lifetime"):e.expires=o+3600,e.scope?(e.scopes=e.scope.split(" "),delete e.scope):n.scopes?e.scopes=n.scopes:e.scopes=[],t.log("processTokenResponse completed ",e,""),this.store.saveToken(n.connector_name,e);var r=new CustomEvent("signal-token-received",{bubbles:!1,detail:e});return document.dispatchEvent(r),e}},{key:"processAuthorizationCodeResponse",value:function(e){var n,o=this;if(!e.state)throw new Error("Could not find state paramter from callback.");if(null===(n=this.store.getState(e.state)))throw new Error("Could not find retrieve state object.");if(console.log("state",n),this.config.has("token")){var r=new Headers;r.append("Content-Type","application/x-www-form-urlencoded;charset=UTF-8");var i={grant_type:"authorization_code",client_id:this.config.getValue("client_id"),code:e.code};this.config.getValue("use_pkce",!1)&&(i.code_verifier=n.code_verifier),n.hasOwnProperty("redirect_uri")&&(i.redirect_uri=n.redirect_uri);var c={mode:"cors",headers:r,method:"POST",body:t.encodeQS(i)};return fetch(this.config.getValue("token"),c).then((function(e){return e.json()})).then((function(e){return t.log("Received response on token endpoint ",e,""),o.processReceivedToken(e,n)}))}t.log("Received an authorization code. Will not process it as the config option [token] endpoint is not set. If you would like to process the code yourself, please subscribe to the [authorizationCode] event")}},{key:"processErrorResponse",value:function(e){var t;if(!e.state)throw new Error("Could not get [state] and no default connector_name is provided.");if(!(t=this.store.getState(e.state)))throw new Error("Could not retrieve state");if(!t.connector_name)throw new Error("Could not get connector_name from state");return t.restoreHash?window.location.hash=t.restoreHash:window.location.hash="",new $(e)}},{key:"callback",value:function(e){var n=null;if("object"===ie(e))n=e;else if("string"==typeof e)n=t.getResponseFromURL(e);else{if(void 0!==e)return;n=t.getResponseFromURL(window.location.href)}if(t.log("Receving response in callback",n),n.hasOwnProperty("access_token"))return this.processTokenResponse(n);if(n.hasOwnProperty("code"))return this.processAuthorizationCodeResponse(n);if(n.hasOwnProperty("error"))throw this.processErrorResponse(n)}},{key:"dump",value:function(){var e=this.store.getTokens(this.connector_name);return{connector_name:this.connector_name,tokens:e,config:this.config}}},{key:"_getRequestScopes",value:function(e){var n,o=[];if(this.config.has("scopes.request")){var r=this.config.getValue("scopes.request");for(n=0;n<r.length;n++)o.push(r[n])}if(e&&e.scopes&&e.scopes.request)for(n=0;n<e.scopes.request.length;n++)o.push(e.scopes.request[n]);return t.uniqueList(o)}},{key:"_getRequiredScopes",value:function(e){var n,o=[];if(this.config.has("scopes.require")){var r=this.config.getValue("scopes.require");for(n=0;n<r.length;n++)o.push(r[n])}if(e&&e.scopes&&e.scopes.require)for(n=0;n<e.scopes.require.length;n++)o.push(e.scopes.require[n]);return t.uniqueList(o)}},{key:"getToken",value:function(e){return this.store.getToken(this.connector_name,this.config.config.scopes)}},{key:"_authorize2",value:function(e,n,o){var r=this,i=this.config.getValue("authorization",null,!0);t.log("Debug Authentication request object",JSON.stringify(e,void 0,2));var c=t.encodeURL(i,e);this.config.getValue("use_pkce",!1)&&(e.code_verifier=n),window.location.hash&&(e.restoreHash=window.location.hash),e.connector_name=this.connector_name,o&&(e.scopes=o),t.log("Saving state ["+e.state+"]"),t.log(JSON.parse(JSON.stringify(e)));var u=this.Loader;return this.store.saveState(e.state,e),this.gotoAuthorizeURL(c,u).then((function(e){if(!0!==e)return r.callback(e)}))}},{key:"authorize",value:function(){var e,n,o,r=this,i=this.config.getValue("authorization",null,!0),c=this.config.getValue("client_id",null,!0),u=this.config.getValue("use_pkce",!1);if(t.log("About to send an authorization request to this endpoint",i),(e={}).state=t.uuid(),e.response_type=this.config.getValue("response_type","id_token token"),u&&(e.response_type="code"),this.config.has("redirect_uri")&&(e.redirect_uri=this.config.getValue("redirect_uri","")),e.client_id=c,o=(n=this.config.config.scopes).includes("openid"),n.length>0&&(e.scope=t.scopeList(n)),t.log("Running in mode: "+(o?"OpenID Connect mode":"OAuth mode")),o&&!e.hasOwnProperty("redirect_uri"))throw new Error("An OpenID Request requires a redirect_uri to be set. Please add to configuration. A redirect_uri is not required for plain OAuth");o&&(e.nonce=t.uuid());var a=null;if(!u)return this._authorize2(e,a,n);if(!window.crypto)throw new Error("Browser crypto APIs are not available");var s=new Uint8Array(64);window.crypto.getRandomValues(s),a=t.base64UrlSafeEncode(s),t.getCodeChallenge(a).then((function(t){return e.code_challenge=t,e.code_challenge_method="S256",r._authorize2(e,a,n)}))}},{key:"gotoAuthorizeURL",value:function(e,t){return new Promise((function(n,o){if(null!==t&&"function"==typeof t){var r=new t(e);if(!(r instanceof u))throw new Error("JSO selected Loader is not an instance of BasicLoader.");n(r.execute())}else o(new Error("Cannot redirect to authorization endpoint because of missing redirect handler"))}))}},{key:"wipeTokens",value:function(){this.store.wipeTokens(this.connector_name)}}])&&ce(n.prototype,o),s}(re)})(),o})()}));
//# sourceMappingURL=jso.js.map